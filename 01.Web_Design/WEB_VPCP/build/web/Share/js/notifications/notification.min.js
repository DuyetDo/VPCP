var notificationGroup=function(t,i,e){var o=/(.*)index.zul/,n=o.exec(window.location.pathname);if(0!=n.length){this.projectName=n[1],this.loadMoreRootNotificationURL=window.location.origin+this.projectName+"rest/notification/loadMoreRootNotifications",this.loadMoreSubNotificationURL=window.location.origin+this.projectName+"rest/notification/loadMoreSubNotifications",this.sendNotificationURL=window.location.origin+this.projectName+"rest/notification/sendNotification",this.loadReceiversURL=window.location.origin+this.projectName+"rest/notification/loadReceivers",this.loadAttachsURL=window.location.origin+this.projectName+"rest/attachs/list-ajax",this.viewAttachURL=window.location.origin+this.projectName+"FileViewerUrl.do",this.toIndex=null,this.fromIndex=null,this.$rootNotificationList=null,this.$viewMoreNotificationsRow=null,this.objectId=t,this.objectType=i,this.currentUserId=e,this.wdNotificationSide=zk.Widget.$("$wdNotificationSide"),this.zkAttachBox=this.wdNotificationSide.getChildAt(0).getChildAt(0),this.$rootNotificationList=$("#notificationList"),this.$rootCommentRow=this.createCommentBox(e),this.$rootNotificationList.append(this.$rootCommentRow);var a=zk.Widget.$("$grbxNotificationSide"),r=$("#"+a.uuid+"-cave"),s=$("#"+a.uuid+"-header"),c=$(".documentViewTable").children("tbody").children("tr").children("td");this.notificationContainer=$("#notificationContainer"),this.notificationContainer.height(c.height());var d=this;new ResizeSensor(c,function(t){var i=c.height()-s.height()-2;r.height(i),d.notificationContainer.height(i)}),this.disableForm=!1,this.procesType={main:0,cooperate:1,receiveToKnow:2,opinion:3,proclaim:6},moment.locale("vi")}};notificationGroup.prototype={resizeNotificationContainer:function(){var t=zk.Widget.$("$grbxNotificationSide"),i=$("#"+t.uuid+"-cave");this.notificationContainer=$("#notificationContainer"),this.notificationContainer.height(i.height())},loadMoreRootNotifications:function(t,i){var e=this;e.disableForm||(e.disableForm=!0,$.ajax({url:this.loadMoreRootNotificationURL+"?objectId="+this.objectId+"&objectType="+this.objectType+"&fromIndex="+this.fromIndex,type:"POST",success:function(t){e.drawRootNotifications(t.list,t.fromIndex,t.toIndex),e.disableForm=!1},error:function(t,i,o){e.disableForm=!1},timeout:3e3}))},drawRootNotifications:function(t,i,e,o,n){(i<this.fromIndex||null===this.fromIndex)&&(this.fromIndex=i),(e>this.toIndex||null===this.toIndex)&&(this.toIndex=e);var a=t.length;if(this.$viewMoreNotificationsRow||this.$rootNotificationList.append(this.createViewMoreNotifications()),this.refreshViewMoreNotifications(),o)for(var r=0;a>r;r++){this.createNotification(t[r]).insertAfter(this.$rootNotificationList.find(">:first-child")).show("slow");var s=this.createSubNotificationList(t[r]);s&&s.insertBefore(this.$viewMoreNotificationsRow)}else for(var r=0;a>r;r++){this.createNotification(t[r]).insertBefore(this.$viewMoreNotificationsRow).show("slow");var s=this.createSubNotificationList(t[r]);s&&s.insertBefore(this.$viewMoreNotificationsRow)}n||(group.zkAttachBox.detach(),group.createAttachBox(group.$rootCommentRow))},loadMoreSubNotifications:function(t,i){var e=this;e.disableForm||(e.disableForm=!0,$.ajax({url:this.loadMoreSubNotificationURL+"?notifyId="+t,type:"POST",success:function(o){e.drawSubNotifications(t,o,i),e.disableForm=!1},error:function(t,i,o){e.disableForm=!1}}))},drawSubNotifications:function(t,i,e){var o=i?i.length:0;e||(e=$("#notification_"+t+" + .UFIReplyList").first());var n=$("#notification_"+t),a=n.next(),r=a.find(".UFIAddComment");if(0===r.length)for(var s=0;o>s;s++)this.createNotification(i[s]).appendTo(e).show("slow");else for(var s=0;o>s;s++)this.createNotification(i[s]).insertBefore(r[0]).show("slow");0===a.find(".UFIReplySocialSentenceRow").length&&e.prepend(this.createViewMoreReplies(t,e))},createCommentBox:function(t,i){var e=$("<div>",{"class":"UFIRow UFIComponent UFIAddComment UFIComment display"}),o=this.createAvatar(t),n=this.createInputBox(i);return e.append(o),e.append(n),e},createNotification:function(t){var i="";t.type&&3===t.type&&(i="UFICommentOpinion");var e=$("<div>",{id:"notification_"+t.notifyId,"class":"UFIRow UFIComment display UFIComponent "+i,parentId:t.parentId,css:{display:"none"}}),o=this.createAvatar(t.sendUserId),n=this.createCommentContent(t);return e.append(o),e.append(n),e},createSubNotificationList:function(t,i){if(t.numberOfChildren||i){var e=$("<div>",{"class":"UFIReplyList"});if(!i){var o=this.createViewMoreReplies(t.notifyId,e);e.append(o)}return e}return null},createAvatar:function(t){var i=$("<div>",{"class":"lfloat"}),e=$("<a>",{"class":"UFIImageBlockImage",href:"#"}),o=$("<img>",{"class":"img UFIActorImage",src:this.projectName+"Share/avatar/"+t});return o.onerror=this.imgError(o),o.appendTo(e),e.appendTo(i),i},imgError:function(t){return t.onerror="",t.attr("src",this.projectName+"Share/avatar/default-avatar.png"),!0},createCommentContent:function(t){var i=$("<div>",{"class":"UFICommentContentBlock"}),e=$("<div>",{"class":"UFICommentContent"});i.append(e);var o=$("<span>",{html:t.sendUserName}),n=$("<a>",{"class":"UFICommentActorName"}),a=$("<span>");n.append(o),a.append(n),e.append(a);var r=$("<span>",{"class":"UFICommentBody",html:t.content?t.content:"&nbsp;"});e.append(r);var s=$("<div>",{"class":"UFICommentActions"}),c=/(processId:\d+)/g,d=t.receiver.match(c)?t.receiver.match(c).length:0,p=t.receiver.match(/(deptId:null)/g)?t.receiver.match(/(deptId:null)/g).length:0,f=this;if(0===p){var l=!t.parentId&&t.receiver&&t.receiver.match(c);if(l){var h=$("<a>",{html:d+" người nhận"}),u=h.parents(".UFICommentOpinion"),m=!1;u.length>0&&(m=!0),h.hover(function(i){var e=$(this).siblings("div.receiverContainer");e.length?e.css("visibility","visible"):$.ajax({url:group.loadReceiversURL,type:"POST",data:"notifyId="+t.notifyId,success:function(t){var i=group.createReceiverList(t,m),e=h.position(),o=h.outerWidth();i.css({position:"absolute",top:e.top+"px",left:e.left+o+"px"}).show(),h.addClass("isLoad"),h.parent().append(i)},error:function(t,i,e){},timeout:3e3})},function(){var t=s.children("div.receiverContainer");t.css("visibility","hidden")})}}var v=$("<a>",{html:"Trả lời"});v.on("click",function(){var i;"undefined"!=typeof t&&(i="undefined"==typeof t.parentId||null===t.parentId?t.notifyId:t.parentId);var e=group.checkExistsSubNotifications(i);if(e){var o=e.find(".UFIInputContainer");if(o.length>0){var n="@"+t.sendUserName;o.find(".reply-to-badge").html(n),o.find("textarea").css("text-indent",6.7*n.length),o.find("textarea").focus()}else e.append(f.createCommentBox(this.currentUserId,t))}else group.drawSubNotificationsWithOnlyTextbox(t),e=group.checkExistsSubNotifications(i),group.showHideSubNotifications(i),e.append(f.createCommentBox(this.currentUserId,t))});var I=$("<span>",{"class":"timestamp"}),g=$("<abbr>",{html:moment(t.sendTime,"YYYY-MM-DD'T'HH:mm:ss'7'").fromNow()});if(I.append(g),s.append(h),s.append($("<span>",{html:"&nbsp;&nbsp;&nbsp;&nbsp;"})),s.append(v),s.append($("<span>",{html:"&nbsp;&nbsp;&nbsp;&nbsp;"})),s.append(I),e.append(s),t.numberOfAttachs){var w=$("<a>",{html:"File đính kèm"});w.on("click",function(){$.ajax({url:group.loadAttachsURL,type:"POST",success:function(t){group.createAttachs(w,t)},error:function(t,i,e){},data:"objectId="+t.notifyId+"&objectType=8",timeout:3e3})}),e.append(w)}return i},createAttachs:function(t,i){for(var e=0;e<i.length;e++){var o=$("<a>",{html:i[e].attachName,href:group.viewAttachURL+"?attachId="+i[e].attachId});o.insertAfter(t)}t.detach()},createInputBox:function(t){var i,e,o,n,a=$("<div>",{"class":"UFIImageBlockContent"}),r=$("<div>",{"class":"UFIInputContainer"}),s=$("<textarea>",{rows:2}),c=this;if("undefined"!=typeof t&&(i="undefined"==typeof t.parentId||null===t.parentId?t.notifyId:t.parentId,e=t.sendUserId,o=t.sendRoleId,n=t.sendDeptId),c.disableForm=!0,s.on("keypress",function(t){if(13===t.keyCode&&(t.preventDefault(),s.val())){var a=null;if(i){var r=$("#notification_"+i),d=r.next(),p=d.find(".UFIRow .UFICommentContent");a=p.length}else a=c.toIndex;c.sendComment(i,s.val(),a,e,o,n),s.val("")}}),s.focus(function(){group.zkAttachBox.detach(),group.zkAttachBox.setVisible(!0),group.createAttachBox(a.parent())}),r.append(s),"undefined"!=typeof t){var d="@"+t.sendUserName,p=$("<span>",{"class":"reply-to-badge",html:"@"+t.sendUserName});p.insertBefore(s),s.css("text-indent",6.7*d.length),s.focus()}return a.append(r),a},createAttachBox:function(t){var i=$("<div>",{"class":"attachbox"});return i.insertAfter(t),this.zkAttachBox.replaceHTML(i),i},sendComment:function(t,i,e,o,n,a){var r={fromIndex:e,parentId:t,content:i,receiverUserId:o,receiverRoleId:n,receiverDeptId:a};zAu.send(new zk.Event(group.wdNotificationSide,"onSendComment",r))},createViewMoreReplies:function(t,i){var e=$("<div>",{"class":"UFIRow UFIReplySocialSentenceRow UFIFirstComponent UFILastComponent"}),o=$("<a>",{"class":"UFIShareLink"});o.on("click",function(){group.showHideSubNotifications(t)}),e.append(o);var n=$("<div>",{"class":"UFIImageBlockImage lfloat"}),a=$("<i>",{"class":"UFIPagerIcon"});n.append(a),o.append(n);var r=$("<div>",{"class":"UFIImageBlockContent"}),s=$("<span>",{"class":"UFIReplySocialSentenceLinkText UFIReplySocialSentenceVerified",html:i.find(".UFIRow.UFIComment").length>0?"Ẩn ý kiến":"Hiển thị ý kiến"});return r.append(s),o.append(r),e},createViewMoreNotifications:function(){this.$viewMoreNotificationsRow=$("<div>",{"class":"UFIRow UFIPagerRow UFIComponent UFILastCommentComponent"});var t=$("<div>",{"class":"rfloat"}),i=$("<span>",{"class":"UFIPagerCount",html:this.toIndex-this.fromIndex+" / "+this.toIndex});t.append(i),this.$viewMoreNotificationsRow.append(t);var e=$("<div>"),o=$("<a>",{"class":"UFIPagerLink"}),n=this;o.on("click",function(){n.loadMoreRootNotifications(n.objectId,n.objectType)});var a=$("<span>",{html:"Hiển thị thêm ý kiến"});return o.append(a),e.append(o),this.$viewMoreNotificationsRow.append(e),this.$viewMoreNotificationsRow},refreshViewMoreNotifications:function(){0!==this.fromIndex?$(".UFIPagerLink>span").first().html("Hiển thị thêm ý kiến"):($(".UFIPagerLink").off("click"),$(".UFIPagerLink").hide()),$(".UFIPagerCount").first().html(this.toIndex-this.fromIndex+" / "+this.toIndex)},createReceiverList:function(t,i){var e=$("<div>",{"class":"receiverContainer"});e.css("zIndex",10);var o=$("<ul>",{"class":"receiverContent"});e.append(o);for(var n=t.receivers.length,a=0;n>a;a++){var r=t.receivers[a].receiveUser?t.receivers[a].receiveUser:t.receivers[a].receiveGroup,s=$("<li>",{html:r});if(!i){var c=$("<div>",{"class":"liLeft"});t.receivers[a].processType===group.procesType.main?c.addClass("li-main"):t.receivers[a].processType===group.procesType.cooperate?c.addClass("li-cooperate"):t.receivers[a].processType===group.procesType.receiveToKnow&&c.addClass("li-receiveToKnow"),s.append(c)}o.append(s)}if(t.numberOfRestReceivers){var s=$("<li>",{html:"và "+t.numberOfRestReceivers+" người nữa"});o.append(s)}return e},replyNotification:function(t){var i=t.parentId?t.parentId:t.notifyId;group.checkExistsSubNotifications(i)||group.drawSubNotificationsWithOnlyTextbox(t)},checkExistsSubNotifications:function(t){for(var i=$("#notification_"+t),e=i.next(),o=e.attr("class").split(/\s+/),n=0;n<o.length;n++)if("UFIReplyList"===o[n])return $(e[n]);return null},focusOnSubTextbox:function(t){$("#notification_"+t+" + .UFIReplyList textarea").first().focus()},showHideSubNotifications:function(t){$subNotificationList=$("#notification_"+t+" + .UFIReplyList").first(),$subNotificationList.children(".UFIRow.UFIComment").length>0?$subNotificationList.children(".UFIRow.UFIComment").is(":visible")?($subNotificationList.children(".UFIRow.UFIComment").hide("slow"),$subNotificationList.find("span.UFIReplySocialSentenceLinkText").text("Hiển thị ý kiến")):($subNotificationList.children(".UFIRow.UFIComment").show("slow"),$subNotificationList.find("span.UFIReplySocialSentenceLinkText").text("Ẩn ý kiến")):(group.loadMoreSubNotifications(t,$subNotificationList),$subNotificationList.find("span.UFIReplySocialSentenceLinkText").text("Ẩn ý kiến"))},drawSubNotificationsWithOnlyTextbox:function(t){var i=group.createSubNotificationList(t,!0),e=group.$rootNotificationList.find("#notification_"+t.notifyId);group.drawSubNotifications(t.notifyId,null,i),i.insertAfter(e)}};